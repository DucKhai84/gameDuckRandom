<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Launcher & Data Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- C·∫§U H√åNH CHUNG --- */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            background-image: url("FINAL.png");
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        /* --- TOAST NOTIFICATION --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 280px;
            padding: 15px 20px;
            border-radius: 12px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInToast 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            backdrop-filter: blur(8px);
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        .toast.success {
            background: rgba(34, 197, 94, 0.95);
            border-left: 5px solid #14532d;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.95);
            border-left: 5px solid #7f1d1d;
        }

        .toast.reminder {
            background: rgba(249, 115, 22, 0.95);
            border-left: 5px solid #7c2d12;
            animation: pulse-toast 2s infinite;
        }

        @keyframes slideInToast {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOutToast {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes pulse-toast {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        /* --- WIDGET MENU --- */
        .glass-nav {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: max-content;
            max-width: 95vw;
            padding: 15px 25px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            animation: slideInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes slideInUp {
            from {
                transform: translate(-50%, 50px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* --- MENU LIST --- */
        .nav-list {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding-right: 20px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 12px;
            text-decoration: none;
            color: #1f2937;
            transition: all 0.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.4);
            width: 70px;
            cursor: pointer;
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            background: #fff;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            box-shadow: 0 8px 20px rgba(255, 94, 98, 0.4);
            transform: translateY(-5px);
            color: white;
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .nav-item.history-btn:hover {
            background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.4);
        }

        .nav-item.disabled {
            opacity: 0.5;
            filter: grayscale(100%);
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.05);
        }

        /* --- ADMIN SECTION --- */
        .admin-section {
            display: flex;
            align-items: center;
        }

        .btn-grid {
            display: flex;
            gap: 15px;
        }

        .admin-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        /* N√∫t Import */
        .file-upload-label {
            background: #fff;
            border: 2px dashed #94a3b8;
            color: #475569;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 700;
            text-align: center;
            width: 90px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .file-upload-label:hover {
            background: #f0f9ff;
            color: #0284c7;
            border-color: #0284c7;
        }

        input[type="file"] {
            display: none;
        }

        /* N√∫t S·ª≠a (View/Edit) */
        .btn-view-list {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 3px 8px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-view-list:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(99, 102, 241, 0.4);
        }

        /* --- MODAL QU·∫¢N L√ù D·ªÆ LI·ªÜU --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-box {
            background: #fff;
            width: 95%;
            max-width: 900px;
            height: 85vh;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
            font-size: 1.2rem;
            color: #1e293b;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        /* Toolbar (Add + Search) */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-add-row {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-add-row:hover {
            background: #2563eb;
        }

        /* Search Input */
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box input {
            padding: 8px 10px 8px 35px;
            /* Ch·ª´a ch·ªó cho icon */
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            transition: 0.2s;
            width: 200px;
        }

        .search-box input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 10px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* Table Editor Style */
        .editor-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .editor-table th {
            background: #f8fafc;
            padding: 12px 10px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            color: #475569;
        }

        .editor-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .editable-cell {
            background: #fff;
            border: 1px solid transparent;
            padding: 8px;
            border-radius: 6px;
            transition: 0.2s;
        }

        .editable-cell:focus {
            background: #fffbeb;
            border-color: #f59e0b;
            outline: none;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .editable-cell:hover {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        .delete-row-btn {
            color: #ef4444;
            background: #fee2e2;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .delete-row-btn:hover {
            background: #ef4444;
            color: #fff;
        }

        .modal-footer {
            padding-top: 15px;
            border-top: 2px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
            transition: 0.2s;
            font-size: 1rem;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-clear-all {
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-clear-all:hover {
            background: #ef4444;
            color: white;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

    <div id="toast-container"></div>

    <div class="glass-nav">
        <nav class="nav-list">
            <a href="./duck-v2/index.html" class="nav-item">
                <img src="https://cdn-icons-png.flaticon.com/512/2663/2663004.png" class="nav-icon" alt="Duck">
                <span class="nav-label">ƒêua V·ªãt</span>
            </a>
            <a href="./Horse-v3/horse.html" class="nav-item">
                <img src="https://cdn-icons-png.flaticon.com/512/2316/2316654.png" class="nav-icon" alt="Horse">
                <span class="nav-label">ƒêua Ng·ª±a</span>
            </a>
            <a href="./Random/ramdom.html" class="nav-item">
                <img src="https://cdn-icons-png.flaticon.com/512/3571/3571276.png" class="nav-icon" alt="Random">
                <span class="nav-label">Quay S·ªë</span>
            </a>
            <a href="./Ticke.me Fake/index.html" class="nav-item">
                <img src="https://cdn-icons-png.flaticon.com/512/4213/4213958.png" class="nav-icon" alt="Ticket">
                <span class="nav-label">V√© S·ªë</span>
            </a>
            <a href="./winner/index.html" class="nav-item history-btn">
                <img src="https://cdn-icons-png.flaticon.com/512/3112/3112946.png" class="nav-icon" alt="History">
                <span class="nav-label">K·∫øt Qu·∫£</span>
            </a>
        </nav>

        <div class="admin-section">
            <div class="btn-grid">
                <div class="admin-group">
                    <label for="csvEmp" class="file-upload-label" title="Import File Excel/CSV">
                        <i class="fa-solid fa-file-import"></i> Import
                    </label>
                    <input type="file" id="csvEmp" accept=".csv, .xlsx, .xls">
                    <button class="btn-view-list" onclick="manageData('emp')">
                        <i class="fa-solid fa-users-gear"></i> Xem DS NV
                    </button>
                </div>

                <div class="admin-group">
                    <label for="csvPrize" class="file-upload-label" title="Import File Excel/CSV">
                        <i class="fa-solid fa-file-import"></i> Import
                    </label>
                    <input type="file" id="csvPrize" accept=".csv, .xlsx, .xls">
                    <button class="btn-view-list" onclick="manageData('prize')">
                        <i class="fa-solid fa-gift"></i> Xem DS Qu√†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="manageModal" class="modal-overlay" onclick="if(event.target == this) closeManageModal()">
        <div class="modal-box">
            <div class="modal-header">
                <span id="modalTitle">Qu·∫£n L√Ω D·ªØ Li·ªáu</span>
                <span style="cursor:pointer; font-size:1.5rem; color:#64748b;"
                    onclick="closeManageModal()">&times;</span>
            </div>

            <div class="toolbar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-add-row" onclick="addNewRow()">
                        <i class="fa-solid fa-plus"></i> Th√™m D√≤ng M·ªõi
                    </button>
                    <span style="font-size:0.85rem; color:#64748b;">T·ªïng: <b id="totalCount">0</b></span>
                </div>

                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." onkeyup="handleSearch()">
                </div>
            </div>

            <div class="modal-body">
                <div id="tableContainer">
                </div>
            </div>

            <div class="modal-footer">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button class="btn-clear-all" onclick="clearAllData()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
                </div>
                <button class="btn-save" onclick="saveCurrentData()">üíæ L∆ØU THAY ƒê·ªîI</button>
            </div>
        </div>
    </div>

    <script>
        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'info', duration = 3000, id = null) {
            const container = document.getElementById('toast-container');
            if (id && document.getElementById(id)) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            if (id) toast.id = id;
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ'; else if (type === 'error') icon = '‚ùå'; else if (type === 'reminder') icon = '‚ö†Ô∏è';
            toast.innerHTML = `<span style="font-size:1.2rem">${icon}</span><span style="flex:1">${message}</span>${duration === 0 ? '' : '<span style="cursor:pointer; opacity:0.7" onclick="this.parentElement.remove()">‚úñ</span>'}`;
            container.appendChild(toast);
            if (duration > 0) { setTimeout(() => { toast.style.animation = 'fadeOutToast 0.5s forwards'; setTimeout(() => toast.remove(), 500); }, duration); }
        }
        function removeToastById(id) { const toast = document.getElementById(id); if (toast) { toast.style.animation = 'fadeOutToast 0.5s forwards'; setTimeout(() => toast.remove(), 500); } }

        // --- GLOBAL VARIABLES FOR EDITING ---
        let currentEditType = ''; // 'emp' or 'prize'
        let currentData = [];
        let currentSearchTerm = ''; // Bi·∫øn l∆∞u t·ª´ kh√≥a t√¨m ki·∫øm

        // --- IMPORT CSV LOGIC (Gi·ªØ nguy√™n) ---
        document.getElementById('csvEmp').addEventListener('change', function (e) { handleImport(e, 'emp'); });
        document.getElementById('csvPrize').addEventListener('change', function (e) { handleImport(e, 'prize'); });

        function handleImport(e, type) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to array of arrays
                    // header: 1 gives us raw array of arrays [[A1, B1], [A2, B2]]
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const newData = [];

                    // Helper to clean cell data
                    const clean = (val) => (val === undefined || val === null) ? '' : String(val).trim();

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (row.length === 0) continue;

                        // Check if header row (skip)
                        const firstCell = clean(row[0]).toLowerCase();
                        if (i === 0 && (firstCell.includes('stt') || firstCell.includes('t√™n') || firstCell.includes('name') || firstCell.includes('m√£') || firstCell.includes('gi·∫£i'))) {
                            continue;
                        }

                        // EMP Logic
                        if (type === 'emp') {
                            // Expected: STT | Name | ID  OR  Name | ID
                            let stt, name, id;

                            // Remove empty cells from end of row
                            while (row.length > 0 && (row[row.length - 1] === undefined || row[row.length - 1] === null || String(row[row.length - 1]).trim() === '')) {
                                row.pop();
                            }

                            if (row.length >= 3) {
                                stt = clean(row[0]);
                                id = clean(row[1]); // Swapped: ID is usually 2nd if reversed? Or User said ID & Name reversed.
                                // If default was Name(1), ID(2). User says reversed -> ID(1), Name(2).
                                name = clean(row[2]);
                            } else if (row.length === 2) {
                                stt = newData.length + 1;
                                id = clean(row[0]); // Swapped
                                name = clean(row[1]);
                            } else if (row.length === 1) {
                                stt = newData.length + 1;
                                id = clean(row[0]); // Assume ID if only 1 col? Or Name?
                                // If reversed, maybe Name is safest fallback, or ID.
                                // Let's keep it as is or logical swap?
                                // If 1 col, usually it's Name list.
                                // But if user is ID-centric...
                                // Let's stick to:
                                name = clean(row[0]);
                                id = '';
                            }

                            if (name) {
                                newData.push({ stt, name, id });
                            }

                        } else {
                            // PRIZE Logic: Name | Quantity | Item | Image
                            let name, quantity, item, image;
                            if (row.length >= 2) {
                                name = clean(row[0]);
                                quantity = parseInt(clean(row[1])) || 1;
                                item = clean(row[2]);
                                image = clean(row[3]);

                                if (name) {
                                    newData.push({ name, quantity, item, image });
                                }
                            }
                        }
                    }

                    console.log("Parsed Data (XLSX):", newData);

                    if (newData.length > 0) {
                        const key = type === 'emp' ? 'lucky_draw_participants' : 'lucky_draw_prizes';
                        localStorage.setItem(key, JSON.stringify(newData));
                        showToast(`ƒê√£ import th√†nh c√¥ng ${newData.length} d√≤ng!`, 'success');
                        checkGameLock && checkGameLock(); // Call if exists

                        if (document.getElementById('manageModal').style.display === 'flex' && currentEditType === type) {
                            manageData(type);
                        }
                    } else {
                        showToast("File kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!", 'error');
                    }

                } catch (e) {
                    console.error("Import Error:", e);
                    showToast("L·ªói khi ƒë·ªçc file: " + e.message, 'error');
                }

                // Reset input
                e.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        // --- MANAGE DATA LOGIC ---
        function manageData(type) {
            currentEditType = type;
            const key = type === 'emp' ? 'lucky_draw_participants' : 'lucky_draw_prizes';
            const rawData = localStorage.getItem(key);

            if (!rawData) {
                currentData = [];
            } else {
                currentData = JSON.parse(rawData);
            }

            document.getElementById('modalTitle').innerText = type === 'emp' ? 'Qu·∫£n L√Ω Nh√¢n Vi√™n' : 'Qu·∫£n L√Ω Gi·∫£i Th∆∞·ªüng';

            // Reset search khi m·ªü modal
            currentSearchTerm = '';
            document.getElementById('searchInput').value = '';

            renderTable();
            document.getElementById('manageModal').style.display = 'flex';
        }

        function closeManageModal() {
            document.getElementById('manageModal').style.display = 'none';
        }

        // --- SEARCH LOGIC ---
        function handleSearch() {
            const input = document.getElementById('searchInput');
            currentSearchTerm = input.value.trim().toLowerCase();
            renderTable();
        }

        // --- LOGIC TH√äM D√íNG M·ªöI ---
        function addNewRow() {
            // Reset search ƒë·ªÉ th·∫•y d√≤ng m·ªõi th√™m
            currentSearchTerm = '';
            document.getElementById('searchInput').value = '';

            if (currentEditType === 'emp') {
                currentData.push({
                    stt: currentData.length + 1,
                    name: 'Nh√¢n vi√™n m·ªõi',
                    id: ''
                });
            } else {
                currentData.push({
                    name: 'Gi·∫£i th∆∞·ªüng m·ªõi',
                    quantity: 1,
                    item: 'Hi·ªán v·∫≠t',
                    image: ''
                });
            }
            renderTable();
            // Scroll xu·ªëng d∆∞·ªõi c√πng
            const modalBody = document.querySelector('.modal-body');
            setTimeout(() => modalBody.scrollTop = modalBody.scrollHeight, 100);
        }

        function renderTable() {
            const container = document.getElementById('tableContainer');
            document.getElementById('totalCount').innerText = currentData.length;

            if (currentData.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o. H√£y Import file ho·∫∑c Th√™m d√≤ng m·ªõi.</div>';
                return;
            }

            let html = '<table class="editor-table"><thead><tr>';

            if (currentEditType === 'emp') {
                html += '<th style="width:50px">STT</th><th>H·ªç v√† T√™n</th><th>M√£ NV</th><th style="width:50px">X√≥a</th>';
            } else {
                html += '<th>T√™n Gi·∫£i</th><th style="width:80px">SL</th><th>Hi·ªán V·∫≠t</th><th style="width:50px">X√≥a</th>';
            }
            html += '</tr></thead><tbody>';

            // Duy·ªát qua d·ªØ li·ªáu (currentData) nh∆∞ng ch·ªâ hi·ªÉn th·ªã d√≤ng kh·ªõp v·ªõi search
            currentData.forEach((row, index) => {
                // Logic Search
                if (currentSearchTerm) {
                    const rowText = Object.values(row).join(' ').toLowerCase();
                    if (!rowText.includes(currentSearchTerm)) return; // B·ªè qua n·∫øu kh√¥ng kh·ªõp
                }

                html += `<tr>`;
                if (currentEditType === 'emp') {
                    html += `
                        <td><div class="editable-cell" contenteditable="true" onblur="updateRow(${index}, 'stt', this.innerText)">${row.stt}</div></td>
                        <td><div class="editable-cell" contenteditable="true" onblur="updateRow(${index}, 'name', this.innerText)">${row.name}</div></td>
                        <td><div class="editable-cell" contenteditable="true" onblur="updateRow(${index}, 'id', this.innerText)">${row.id || ''}</div></td>
                    `;
                } else {
                    html += `
                        <td><div class="editable-cell" contenteditable="true" onblur="updateRow(${index}, 'name', this.innerText)">${row.name}</div></td>
                        <td><div class="editable-cell" contenteditable="true" onblur="updateRow(${index}, 'quantity', this.innerText)">${row.quantity}</div></td>
                        <td><div class="editable-cell" contenteditable="true" onblur="updateRow(${index}, 'item', this.innerText)">${row.item || ''}</div></td>
                    `;
                }
                html += `
                    <td style="text-align:center;">
                        <button class="delete-row-btn" onclick="deleteRow(${index})"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';

            // N·∫øu search kh√¥ng th·∫•y k·∫øt qu·∫£
            if (html.indexOf('<tr>') === -1 && currentData.length > 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</div>';
            } else {
                container.innerHTML = html;
            }
        }

        // L∆∞u √Ω: updateRow v√† deleteRow d√πng 'index' c·ªßa m·∫£ng g·ªëc (currentData)
        // ƒêi·ªÅu n√†y ho·∫°t ƒë·ªông ƒë√∫ng v√¨ khi render, ch√∫ng ta g√°n index g·ªëc v√†o h√†m onclick/onblur
        window.updateRow = function (index, field, value) {
            if (currentEditType === 'prize' && field === 'quantity') {
                currentData[index][field] = parseInt(value) || 0;
            } else {
                currentData[index][field] = value.trim();
            }
        };

        window.deleteRow = function (index) {
            if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng n√†y?')) {
                currentData.splice(index, 1);
                renderTable(); // Render l·∫°i s·∫Ω t·ª± ƒë·ªông √°p d·ª•ng search n·∫øu ƒëang c√≥
            }
        };

        function clearAllData() {
            if (confirm('C·∫¢NH B√ÅO: X√≥a to√†n b·ªô d·ªØ li·ªáu. B·∫°n ch·∫Øc kh√¥ng?')) {
                currentData = [];
                renderTable();
            }
        }

        function saveCurrentData() {
            const key = currentEditType === 'emp' ? 'lucky_draw_participants' : 'lucky_draw_prizes';
            localStorage.setItem(key, JSON.stringify(currentData));

            showToast('‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');
            checkGameLock();
            closeManageModal();
        }

        // --- GAME LOCK ---
        function checkGameLock() {
            const hasParticipants = localStorage.getItem('lucky_draw_participants');
            const hasPrizes = localStorage.getItem('lucky_draw_prizes');
            const pList = hasParticipants ? JSON.parse(hasParticipants) : [];
            const rList = hasPrizes ? JSON.parse(hasPrizes) : [];

            const isLocked = pList.length === 0 || rList.length === 0;
            const REMINDER_ID = 'import-reminder-toast';

            const gameItems = document.querySelectorAll('.nav-item:not(.history-btn)');
            gameItems.forEach(item => {
                if (isLocked) {
                    item.classList.add('disabled');
                    if (item.getAttribute('href')) {
                        item.dataset.href = item.getAttribute('href');
                        item.removeAttribute('href');
                    }
                } else {
                    item.classList.remove('disabled');
                    if (item.dataset.href) {
                        item.setAttribute('href', item.dataset.href);
                    }
                }
            });

            if (isLocked) {
                showToast("‚ö†Ô∏è Vui l√≤ng Import/Nh·∫≠p li·ªáu Nh√¢n vi√™n & Qu√†!", "reminder", 0, REMINDER_ID);
            } else {
                removeToastById(REMINDER_ID);
            }
        }

        document.querySelectorAll('.nav-item:not(.history-btn)').forEach(item => {
            item.addEventListener('click', function (e) {
                if (this.classList.contains('disabled')) {
                    e.preventDefault();
                    const reminder = document.getElementById('import-reminder-toast');
                    if (reminder) {
                        reminder.style.transform = 'scale(1.05)';
                        setTimeout(() => reminder.style.transform = 'scale(1)', 200);
                    } else {
                        showToast("‚ö†Ô∏è Vui l√≤ng Import danh s√°ch Nh√¢n vi√™n & Qu√† ƒë·ªÉ b·∫Øt ƒë·∫ßu!", "reminder", 0, 'import-reminder-toast');
                    }
                }
            });
        });

        window.addEventListener('DOMContentLoaded', checkGameLock);
    </script>

</body>

</html>